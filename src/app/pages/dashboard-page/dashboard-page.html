<div class="bg-background-dark min-h-screen flex pt-4" (click)="closeMenus()">
  <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
    
    <!-- ==================== CONFETTI CELEBRATION ==================== -->
    @if (showConfetti()) {
    <div class="confetti-container" aria-hidden="true">
      @for (i of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]; track i) {
      <div class="confetti" [style.--i]="i"></div>
      }
    </div>
    }

    <!-- ==================== IDENTITY MESSAGE (Long-term users) ==================== -->
    @if (identityMessage() && !isLoading()) {
    <div class="identity-banner mb-6">
      <span class="text-lg">âœ¨</span>
      <span class="font-medium">{{ identityMessage() }}</span>
    </div>
    }

    <!-- ==================== HERO: SINGLE ACTION FOCUS ==================== -->
    <section class="hero-action-card mb-8" [class.hero-stage-complete]="progressNarrative().stage === 'complete'">
      @if (isLoading()) {
      <div class="flex items-center justify-center py-16">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
      </div>
      } @else if (nextHabit(); as habit) {
      <!-- Next Habit to Complete -->
      <div class="text-center">
        <p class="text-sm uppercase tracking-widest text-text-dark-muted mb-4 font-medium">Your Next Action</p>
        <div class="text-6xl mb-4">{{ habit.icon || 'ğŸ¯' }}</div>
        <h1 class="text-3xl font-bold text-text-dark-primary mb-2 font-display">{{ habit.title }}</h1>
        
        <!-- Context: Consequence or Urgency -->
        @if (heroContext(); as ctx) {
        <div class="hero-context mb-4">
          @if (ctx.consequence) {
          <p class="text-primary font-medium">{{ ctx.consequence }}</p>
          }
          @if (ctx.urgency) {
          <p class="text-text-dark-secondary text-sm mt-1">{{ ctx.urgency }}</p>
          }
        </div>
        }
        
        <!-- Explicit CTA with clear action -->
        <button 
          (click)="toggleHabit(habit.id!)"
          class="hero-complete-button"
        >
          <span class="material-symbols-outlined text-2xl">check_circle</span>
          {{ heroContext()?.actionLabel || 'Mark as Done' }}
        </button>

        <!-- Remaining habits indicator -->
        @if (dailyProgress().remaining > 1) {
        <p class="text-sm text-text-dark-muted mt-6">
          â†“ {{ dailyProgress().remaining - 1 }} more habit{{ dailyProgress().remaining > 2 ? 's' : '' }} today
        </p>
        }
      </div>
      } @else if (habits().length === 0) {
      <!-- No Habits Yet -->
      <div class="text-center py-8">
        <div class="text-6xl mb-4 opacity-30">ğŸŒ±</div>
        <h2 class="text-2xl font-bold text-text-dark-primary mb-2 font-display">Start Your Journey</h2>
        <p class="text-text-dark-secondary mb-6">Create your first habit to begin building consistency.</p>
        <button routerLink="/habit/new" class="hero-complete-button">
          <span class="material-symbols-outlined">add</span>
          Create First Habit
        </button>
      </div>
      } @else {
      <!-- All Done for Today -->
      <div class="text-center py-8">
        <div class="text-6xl mb-4">{{ progressNarrative().emoji }}</div>
        <h2 class="text-2xl font-bold text-text-dark-primary mb-2 font-display">{{ progressNarrative().main }}</h2>
        <p class="text-text-dark-secondary mb-4">{{ progressNarrative().sub }}</p>
        <div class="flex justify-center gap-4">
          <button routerLink="/calendar" class="btn-modern flex items-center gap-2">
            <span class="material-symbols-outlined">calendar_month</span>
            View Calendar
          </button>
          <button routerLink="/habit/new" class="btn-modern flex items-center gap-2">
            <span class="material-symbols-outlined">add</span>
            Add Habit
          </button>
        </div>
      </div>
      }
    </section>

    <!-- ==================== PROGRESS BAR WITH EMOTIONAL STAGES ==================== -->
    @if (!isLoading() && dailyProgress().totalHabits > 0) {
    <div class="progress-narrative-bar mb-8" [attr.data-stage]="progressNarrative().stage">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <span class="text-xl">{{ progressNarrative().emoji }}</span>
          <span class="text-lg font-semibold text-text-dark-primary">{{ progressNarrative().main }}</span>
        </div>
        <span class="text-sm text-text-dark-muted">{{ dailyProgress().completedHabits }}/{{ dailyProgress().totalHabits }}</span>
      </div>
      <div class="progress-track-slim">
        <div 
          class="progress-fill-animated" 
          [class.progress-early]="progressNarrative().stage === 'early' || progressNarrative().stage === 'zero'"
          [class.progress-mid]="progressNarrative().stage === 'mid'"
          [class.progress-late]="progressNarrative().stage === 'late'"
          [class.progress-complete]="progressNarrative().stage === 'complete'"
          [style.width.%]="dailyProgress().percentage"
        ></div>
      </div>
      <p class="text-sm text-text-dark-secondary mt-2">{{ progressNarrative().sub }}</p>
    </div>
    }

    <!-- ==================== TODAY'S HABITS ==================== -->
    @if (!isLoading() && habitsForCurrentDate().length > 0) {
    <section class="space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-text-dark-primary">Today's Habits</h2>
        <span class="text-sm text-text-dark-muted">{{ formatDate(currentDate()) }}</span>
      </div>

      <!-- Habit List -->
      <div class="habit-list-container">
        @for (habit of filteredHabits(); track habit.id) {
        <button 
          (click)="toggleHabit(habit.id!)"
          class="habit-row group"
          [class.habit-row-completed]="habit.completedToday"
          [class.habit-row-next]="nextHabit()?.id === habit.id && !habit.completedToday"
        >
          <!-- Checkbox Visual -->
          <div class="habit-checkbox" [class.habit-checkbox-checked]="habit.completedToday">
            @if (habit.completedToday) {
            <span class="material-symbols-outlined text-white text-lg">check</span>
            }
          </div>

          <!-- Habit Info -->
          <div class="habit-icon">{{ habit.icon || 'ğŸ¯' }}</div>
          <div class="flex-1 text-left">
            <h3 class="font-medium text-text-dark-primary" [class.opacity-80]="habit.completedToday">
              {{ habit.title }}
            </h3>
            @if (habit.streakEnabled && (habit.currentStreak || 0) > 0) {
            <span class="text-xs text-text-dark-muted flex items-center gap-1">
              <span>ğŸ”¥</span> {{ habit.currentStreak }} day streak
            </span>
            }
          </div>

          <!-- Completion Indicator (Celebration, not Punishment) -->
          <div class="habit-completion-indicator" [class.active]="habit.completedToday">
            @if (habit.completedToday) {
            <span class="text-primary font-medium text-sm flex items-center gap-1">
              <span class="material-symbols-outlined text-base">check_circle</span>
              Done!
            </span>
            } @else if (nextHabit()?.id === habit.id) {
            <span class="text-primary text-sm font-medium">â† Start here</span>
            } @else {
            <span class="text-text-dark-muted text-sm group-hover:text-primary transition-colors">Tap to complete</span>
            }
          </div>
        </button>
        }
      </div>

      <!-- Add New Habit (Subtle) -->
      <button
        routerLink="/habit/new"
        class="w-full border border-dashed border-border-dark hover:border-primary/50 rounded-xl p-4 flex items-center justify-center gap-2 text-text-dark-muted hover:text-primary transition-all"
      >
        <span class="material-symbols-outlined text-lg">add</span>
        <span class="text-sm">Add new habit</span>
      </button>
    </section>
    }

    <!-- ==================== CELEBRATION CARD (When All Done) ==================== -->
    @if (!isLoading() && dailyProgress().percentage === 100 && habits().length > 0) {
    <section class="celebration-card mt-8">
      <div class="text-center">
        <div class="text-5xl mb-3">ğŸ†</div>
        <h3 class="text-xl font-bold text-text-dark-primary mb-2">Perfect Day Achieved!</h3>
        <p class="text-text-dark-secondary">You completed all {{ dailyProgress().totalHabits }} habits. Keep building.</p>
      </div>
    </section>
    }

  </main>
</div>
