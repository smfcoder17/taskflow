<div class="app-layout" (click)="closeMenus()">
  
  <div class="dashboard-content">
    
    <!-- ==================== HEADER ==================== -->
    <header class="dashboard-header">
      <!-- Left: Title & Date Info -->
      <div class="header-left">
        <h1 class="page-title">Dashboard</h1>
        <div class="header-date-row">
          <span class="header-date">{{ formattedDateWithPrefix() }}</span>
          @if (dailyProgress().totalHabits > 0) {
            <div class="header-progress-pill" [class.complete]="dailyProgress().percentage === 100">
              <span class="pill-value">{{ dailyProgress().percentage }}%</span>
              <div class="pill-bar">
                <div class="pill-fill" [style.width.%]="dailyProgress().percentage"></div>
              </div>
            </div>
          }
        </div>
      </div>
      
      <!-- Right: Date Strip -->
      <div class="date-strip">
        @for (day of dateStrip(); track day.date.toISOString()) {
          <button 
            class="date-chip" 
            [class.is-today]="day.isToday"
            [class.is-selected]="day.isSelected"
            [class.is-future]="day.isFuture"
            (click)="goToDate(day.date)"
          >
            <span class="chip-day">{{ day.dayName }}</span>
            <span class="chip-num">{{ day.dayNum }}</span>
          </button>
        }
      </div>
    </header>
    
    <!-- Future Date Warning -->
    @if (isFutureDate()) {
      <div class="future-warning">
        <span class="material-symbols-outlined">info</span>
        Viewing a future date â€” habits cannot be completed
      </div>
    }

    @if (isLoading()) {
      <div class="loading-state">
        <div class="spinner"></div>
      </div>
    } @else {

      <!-- ==================== CONFETTI ==================== -->
      @if (showConfetti()) {
      <div class="confetti-container" aria-hidden="true">
        @for (i of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]; track i) {
        <div class="confetti" [style.--i]="i"></div>
        }
      </div>
      }

      <!-- ==================== MASTER 2-COLUMN LAYOUT ==================== -->
      <div class="dashboard-columns" [class.is-future]="isFutureDate()">
        
        <!-- ========== LEFT COLUMN (Main) ========== -->
        <div class="list-column">

          <!-- HERO SLOT: Success Banner OR Focus Strip -->
          @if (dailyProgress().percentage === 100 && dailyProgress().totalHabits > 0) {
            <!-- SUCCESS BANNER -->
            <section class="day-complete-card" [class.collapsed]="isCelebrationCollapsed()">
              <div class="complete-header">
                <div class="complete-title-group">
                  <span class="complete-icon">ðŸŽ‰</span>
                  <div class="text-group">
                    <h2 class="complete-title">Way to go, {{ userName() }}!</h2>
                    <p class="complete-subtitle">All {{ dailyProgress().totalHabits }} habits crushed today.</p>
                    @if (isCelebrationCollapsed()) {
                      <div class="compact-stats">
                        <span class="c-stat gold">ðŸ”¥ {{ topStreaks().length > 0 ? topStreaks()[0].currentStreak : 1 }}d streak</span>
                        <span class="c-sep">â€¢</span>
                        <span class="c-stat">âœ… 100% done</span>
                      </div>
                    }
                  </div>
                </div>
                <button class="collapse-btn" (click)="toggleCelebrationCollapse()">
                  <span class="material-symbols-outlined">{{ isCelebrationCollapsed() ? 'expand_more' : 'expand_less' }}</span>
                </button>
              </div>
              <div class="hero-metrics">
                <div class="hero-metric highlight-gold">
                  <span class="hero-val">{{ topStreaks().length > 0 ? topStreaks()[0].currentStreak : 1 }}d</span>
                  <span class="hero-lbl">Current Streak</span>
                </div>
                <div class="hero-metric">
                  <span class="hero-val">{{ dailyProgress().totalHabits }}</span>
                  <span class="hero-lbl">Done Today</span>
                </div>
                <button class="share-btn">
                  <span class="material-symbols-outlined">share</span>
                  Share
                </button>
              </div>
            </section>
          } @else if (nextHabit(); as habit) {
            <!-- FOCUS STRIP (Up Next) -->
            <section class="focus-strip">
              <div class="focus-left">
                <div class="focus-icon-wrapper">
                  <span class="focus-emoji">{{ habit.icon || 'âš¡' }}</span>
                </div>
                <div class="focus-details">
                  <span class="focus-overline">Up Next</span>
                  <h2 class="focus-name">{{ habit.title }}</h2>
                </div>
              </div>
              <div class="focus-right">
                @if (habit.streakEnabled && (habit.currentStreak || 0) >= 2) {
                  <div class="focus-streak-stats">
                    <span class="material-symbols-outlined">local_fire_department</span>
                    <span>{{ habit.currentStreak }} day streak</span>
                  </div>
                }
                <button (click)="toggleHabit(habit.id!)" class="focus-btn-primary">
                  <span class="material-symbols-outlined">check</span>
                  Complete
                </button>
              </div>
            </section>
          }

          <!-- REMAINING HABITS (Excludes nextHabit to avoid duplication) -->
          @if (pendingHabits().length > 0) {
            <div class="habit-group">
              <h3 class="group-title prominent">Remaining ({{ pendingHabits().length }})</h3>
              <div class="card-list">
                @for (habit of pendingHabits(); track habit.id) {
                  <div class="habit-card">
                    <button class="check-trigger" (click)="toggleHabit(habit.id!)">
                      <div class="check-ring"></div>
                    </button>
                    <div class="card-content">
                      <span class="card-title">{{ habit.title }}</span>
                      <div class="card-meta">
                        @if (habit.streakEnabled && (habit.currentStreak || 0) >= 2) {
                          <span class="meta-streak">ðŸ”¥ {{ habit.currentStreak }}</span>
                        }
                      </div>
                    </div>
                    <div class="card-actions">
                      <button class="icon-btn" title="Skip" (click)="$event.stopPropagation()">
                        <span class="material-symbols-outlined">skip_next</span>
                      </button>
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          <!-- COMPLETED HABITS -->
          @if (completedHabits().length > 0) {
            <div class="habit-group completed-group">
              <h3 class="group-title">Done Today ({{ completedHabits().length }})</h3>
              <div class="card-list">
                @for (habit of completedHabits(); track habit.id) {
                  <div class="habit-card completed">
                    <button class="check-trigger checked" (click)="toggleHabit(habit.id!)">
                      <span class="material-symbols-outlined">check</span>
                    </button>
                    <span class="card-title">{{ habit.title }}</span>
                    <span class="card-time">{{ habit.completedAt | date:'shortTime' }}</span>
                  </div>
                }
              </div>
            </div>
          }

          <!-- NEXT DAY FOCUS (Dynamic Label) -->
          <section class="tomorrow-card">
            <div class="tomorrow-header">
              <div class="icon-box">
                <span class="material-symbols-outlined">calendar_today</span>
              </div>
              <div class="text">
                <h3>{{ nextDayLabel() }}</h3>
                <p>{{ tomorrowHabits().length > 0 ? 'Upcoming habits for the next day.' : 'No habits scheduled.' }}</p>
              </div>
            </div>
            @if (tomorrowHabits().length > 0) {
              <ul class="next-day-list">
                @for(habit of tomorrowHabits(); track habit.id) {
                  <li class="next-day-item">
                    <span class="nd-title">{{ habit.title }}</span>
                    <div class="nd-meta">
                      @if(habit.streakEnabled && (habit.currentStreak || 0) > 0) {
                        <span class="nd-streak">ðŸ”¥ {{ habit.currentStreak }}d</span>
                      }
                      @if(habit.timeOfDay) {
                        <span class="nd-time">{{ formatTime(habit.timeOfDay) }}</span>
                      }
                    </div>
                  </li>
                }
              </ul>
            } @else {
              <div class="tomorrow-empty-inline">Enjoy your rest day! ðŸŒ´</div>
            }
          </section>

        </div>

        <!-- ========== RIGHT COLUMN (Widget Grid 2x2) ========== -->
        <div class="widget-grid">
          
          <!-- Floating Customize Button -->
          <div class="widget-customize-float">
            <button 
              class="widget-customize-btn" 
              [class.is-active]="isWidgetEditMode()"
              (click)="toggleWidgetEditMode()"
            >
              <span class="material-symbols-outlined">{{ isWidgetEditMode() ? 'check' : 'tune' }}</span>
              <span class="customize-label">{{ isWidgetEditMode() ? 'Done' : 'Customize' }}</span>
            </button>
          </div>

          <!-- WIDGET 1: Weekly Consistency (Fixed) -->
          <div 
            class="widget-card" 
            [class.is-edit-mode]="isWidgetEditMode()"
            [class.is-dragging]="draggedWidgetIndex() === -1"
            [class.is-drag-over]="dragOverIndex() === -1"
            [attr.draggable]="isWidgetEditMode() ? 'true' : null"
            (dragstart)="onDragStart($event, -1)"
            (dragover)="onDragOver($event, -1)"
            (drop)="onDrop($event, -1)"
            (dragend)="onDragEnd()"
          >
            <div class="widget-header">
              <h3>Weekly Consistency</h3>
              <span class="widget-badge">Last 7 Days</span>
            </div>
            <div class="hub-chart">
              <div class="chart-bars">
                @for (day of weeklyProgress().days; track day.date) {
                  <div class="chart-col" [title]="day.dayName + ': ' + day.completed + '/' + day.total">
                    <div class="bar-track">
                      <div class="bar-ghost"></div>
                      <div 
                        class="bar-fill" 
                        [style.height.%]="day.total > 0 ? (day.completed / day.total * 100) : 0"
                        [class.is-today]="isSameDate(day.date, currentDate())"
                      ></div>
                    </div>
                    <span class="chart-label" [class.highlight]="isSameDate(day.date, currentDate())">{{ day.dayName }}</span>
                  </div>
                }
              </div>
            </div>
            <div class="hub-metrics-row">
              <div class="metric-simple">
                <span class="val">{{ topStreaks().length > 0 ? topStreaks()[0].currentStreak : 0 }}d</span>
                <span class="lbl">Best Streak</span>
              </div>
              <div class="metric-simple">
                <span class="val">{{ dailyProgress().completedHabits }}/{{ dailyProgress().totalHabits }}</span>
                <span class="lbl">Done Today</span>
              </div>
            </div>
          </div>

          <!-- WIDGET SLOTS (Always visible, Draggable in Edit Mode) -->
          @for (widget of widgetSlots(); track $index) {
              <div 
                class="widget-card widget-slot" 
                [class.has-widget]="widget !== null"
                [class.is-empty]="widget === null"
                [class.is-edit-mode]="isWidgetEditMode()"
                [class.is-dragging]="draggedWidgetIndex() === $index"
                [class.is-drag-over]="dragOverIndex() === $index"
                [attr.draggable]="isWidgetEditMode() ? 'true' : null"
                (click)="widget === null && isWidgetEditMode() ? openWidgetPicker($index) : null"
                (dragstart)="onDragStart($event, $index)"
                (dragover)="onDragOver($event, $index)"
                (drop)="onDrop($event, $index)"
                (dragend)="onDragEnd()"
              >
                @if (widget === null) {
                  <div class="widget-add-trigger">
                    <span class="material-symbols-outlined">add</span>
                    <span class="add-label">Add widget</span>
                  </div>
                  
                  @if (showWidgetPicker() === $index) {
                    <div class="widget-picker" (click)="$event.stopPropagation()">
                      <div class="picker-header">
                        <span>Select Widget</span>
                        <button class="picker-close" (click)="closeWidgetPicker()">
                          <span class="material-symbols-outlined">close</span>
                        </button>
                      </div>
                      <div class="picker-options">
                        @for (w of availableWidgets; track w.id) {
                          <button class="picker-option" (click)="addWidget($index, w.id)">
                            <span class="material-symbols-outlined">{{ w.icon }}</span>
                            <span>{{ w.name }}</span>
                          </button>
                        }
                      </div>
                    </div>
                  }
                } @else {
                  <div class="widget-content">
                    <span class="widget-name">{{ widget }}</span>
                    @if (isWidgetEditMode()) {
                      <button class="widget-remove" (click)="removeWidget($index); $event.stopPropagation()">
                        <span class="material-symbols-outlined">close</span>
                      </button>
                    }
                  </div>
                }
              </div>
          }
        </div>

      </div>
    }
  </div>
</div>
