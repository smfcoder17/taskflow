<div class="app-layout" (click)="closeMenus()">
  
  <div class="dashboard-content">
    
    <!-- ==================== HEADER ==================== -->
    <header class="dashboard-header">
      <div class="header-content">
        <h1 class="page-title">Dashboard</h1>
        <span class="header-date">{{ formatDate(currentDate()) }}</span>
      </div>
      <!-- Progress Pill (Subtle global context) -->
      @if (dailyProgress().totalHabits > 0) {
        <div class="header-progress-pill" [class.complete]="dailyProgress().percentage === 100">
          <span class="pill-value">{{ dailyProgress().percentage }}%</span>
          <div class="pill-bar">
            <div class="pill-fill" [style.width.%]="dailyProgress().percentage"></div>
          </div>
        </div>
      }
    </header>

    @if (isLoading()) {
      <div class="loading-state">
        <div class="spinner"></div>
      </div>
    } @else {

      <!-- ==================== CONFETTI ==================== -->
      @if (showConfetti()) {
      <div class="confetti-container" aria-hidden="true">
        @for (i of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]; track i) {
        <div class="confetti" [style.--i]="i"></div>
        }
      </div>
      }

      <!-- ==================== DAY COMPLETE STATE ==================== -->
      @if (dailyProgress().percentage === 100 && dailyProgress().totalHabits > 0) {
      <section class="day-complete-card">
        <div class="complete-content">
          <span class="complete-icon">üèÜ</span>
          <h2 class="complete-title">Crushed it!</h2>
          <p class="complete-subtitle">You've completed all {{ dailyProgress().totalHabits }} habits for today.</p>
          
          <div class="complete-stats-row">
            <div class="mini-stat">
              <span class="label">Streak</span>
              <span class="value">{{ topStreaks().length > 0 ? topStreaks()[0].currentStreak : 1 }}d</span>
            </div>
            <div class="mini-stat">
              <span class="label">Done</span>
              <span class="value">{{ dailyProgress().totalHabits }}</span>
            </div>
          </div>
        </div>
        
        <!-- Collapsible Habit Summary -->
        <div class="complete-summary">
          <div class="summary-list">
             @for (habit of completedHabits(); track habit.id) {
            <div class="summary-item">
              <span class="material-symbols-outlined check-icon">check_circle</span>
              <span class="summary-name">{{ habit.title }}</span>
            </div>
            }
          </div>
        </div>
      </section>
      
      <!-- PROGRESS HUB (Shown at bottom of complete state) -->
       <section class="progress-hub">
        <div class="hub-header">
          <h3>Weekly Progress</h3>
          <span class="hub-subtitle">Last 7 Days</span>
        </div>
        
        <div class="hub-grid">
           <!-- Chart -->
          <div class="hub-chart">
            <div class="chart-bars">
              @for (day of weeklyProgress().days; track day.date) {
              <div class="chart-col" [title]="day.dayName + ': ' + day.completed + '/' + day.total">
                <div class="bar-track">
                  <div 
                    class="bar-fill" 
                    [style.height.%]="day.total > 0 ? (day.completed / day.total * 100) : 0"
                    [class.is-today]="isSameDate(day.date, currentDate())"
                  ></div>
                </div>
                <span class="chart-label">{{ day.dayName.charAt(0) }}</span>
              </div>
              }
            </div>
          </div>

          <!-- Key Metrics -->
          <div class="hub-metrics">
            <div class="metric-tile">
              <span class="metric-val">{{ topStreaks().length > 0 ? topStreaks()[0].currentStreak : 0 }}</span>
              <span class="metric-lbl">Best Streak</span>
            </div>
            <div class="metric-tile">
              <span class="metric-val">{{ Math.round(weeklyProgress().completionRate) }}%</span>
              <span class="metric-lbl"> Consistency</span>
            </div>
          </div>
        </div>
      </section>

      } @else {

      <!-- ==================== FOCUS MODE ==================== -->
      
      <!-- Focus Strip -->
      @if (nextHabit(); as habit) {
      <section class="focus-strip">
        <div class="focus-left">
          <div class="focus-icon-wrapper">
            <span class="focus-emoji">{{ habit.icon || '‚ö°' }}</span>
          </div>
          <div class="focus-details">
            <span class="focus-overline">Up Next</span>
            <h2 class="focus-name">{{ habit.title }}</h2>
          </div>
        </div>
        
        <div class="focus-right">
           @if (habit.streakEnabled) {
            <div class="focus-streak-badge" [class.has-streak]="(habit.currentStreak || 0) > 0">
              <span class="material-symbols-outlined">local_fire_department</span>
              <span>{{ (habit.currentStreak || 0) > 0 ? habit.currentStreak + ' day streak' : 'Start streak' }}</span>
            </div>
          }
          <button (click)="toggleHabit(habit.id!)" class="focus-btn-primary">
            <span class="material-symbols-outlined">check</span>
            Complete
          </button>
        </div>
      </section>
      }

      <!-- Main Columns -->
      <div class="dashboard-columns">
        
        <!-- Left: Habit List -->
        <div class="list-column">
          <!-- Pending -->
           @if (pendingHabits().length > 0) {
          <div class="habit-group">
            <h3 class="group-title">Remaining ({{ pendingHabits().length }})</h3>
            <div class="card-list">
              @for (habit of pendingHabits(); track habit.id) {
              <div class="habit-card" [class.is-next]="nextHabit()?.id === habit.id">
                <button class="check-trigger" (click)="toggleHabit(habit.id!)">
                  <div class="check-ring"></div>
                </button>
                <div class="card-content">
                  <span class="card-title">{{ habit.title }}</span>
                  <div class="card-meta">
                    @if (habit.streakEnabled && (habit.currentStreak || 0) > 0) {
                      <span class="meta-streak">üî• {{ habit.currentStreak }}</span>
                    }
                  </div>
                </div>
                <!-- Hover Actions -->
                <div class="card-actions">
                  <button class="icon-btn" title="Skip" (click)="$event.stopPropagation()">
                     <span class="material-symbols-outlined">skip_next</span>
                  </button>
                </div>
              </div>
              }
            </div>
          </div>
          }

          <!-- Completed Today -->
          @if (completedHabits().length > 0) {
          <div class="habit-group completed-group">
            <h3 class="group-title">Done Today ({{ completedHabits().length }})</h3>
            <div class="card-list">
              @for (habit of completedHabits(); track habit.id) {
              <div class="habit-card completed">
                <button class="check-trigger checked" (click)="toggleHabit(habit.id!)">
                  <span class="material-symbols-outlined">check</span>
                </button>
                <span class="card-title">{{ habit.title }}</span>
              </div>
              }
            </div>
          </div>
          }
        </div>

        <!-- Right: Progress Hub (Visible in Focus Mode too) -->
        <div class="stats-column">
          <section class="progress-hub compact">
            <div class="hub-header">
              <h3>Progress</h3>
            </div>
            <div class="hub-chart">
               <div class="chart-bars">
                @for (day of weeklyProgress().days; track day.date) {
                <div class="chart-col" [title]="day.dayName + ': ' + day.completed + '/' + day.total">
                  <div class="bar-track">
                    <div 
                      class="bar-fill" 
                      [style.height.%]="day.total > 0 ? (day.completed / day.total * 100) : 0"
                      [class.is-today]="isSameDate(day.date, currentDate())"
                    ></div>
                  </div>
                  <span class="chart-label">{{ day.dayName.charAt(0) }}</span>
                </div>
                }
              </div>
            </div>
            
            <div class="hub-metrics-row">
              <div class="metric-simple">
                <span class="val">{{ topStreaks().length > 0 ? topStreaks()[0].currentStreak : 0 }}</span>
                <span class="lbl">Best Streak</span>
              </div>
               <div class="metric-simple">
                <span class="val">{{ dailyProgress().completedHabits }}</span>
                <span class="lbl">Done</span>
              </div>
            </div>
          </section>
        </div>

      </div>

      }
    }
  </div>
</div>
